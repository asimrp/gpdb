<span id="title-text"> Storage & Access : RCA for AO Catalog Issues </span>
===========================================================================

This page last changed on Jan 07, 2015 by apraveen.

Intent of this page is to log appendonly catalog issues encountered in the field and whose root cause is yet to be determined. The page lists inputs that should be collected for each issue, in case it is encountered again.

Auxiliary tables missing on one or more (but not all) segments
--------------------------------------------------------------

<a href="https://jira.eng.pivotal.io/browse/MPP-25218" class="external-link">MPP-25218</a> is one such issue. On one of the segments, `pg_class` is missing tuples for auxiliary tables for a column oriented appendonly table. Information for the auxiliary tables is present in other catalog tables such as `pg_type`, `pg_attribute` and `pg_index`. Auxiliary tables are `pg_aocsseg_<oid>`, `pg_aovisimap_<oid>`, `pg_toast_<oid>` and index on each of these. Note that the tuple for the base appendonly table was present in `pg_class`. The issue should be manifested by gpcheckcat failures and errors such as the following when querying the troubled appendonly table:

``` theme:
ERROR: relation with OID 10891967 does not exist (seg24 slice1 idb27.devin3.ms.com:16726 pid=763744)
CONTEXT: SQL statement "select vpinfo from gp_dist_random('pg_aoseg.pg_aocsseg_10891962')"
```

The following inputs are needed to root cause this issue:

1.  DDL of the base table.
2.  How was the DDL executed, as an independent command from psql or through a function?
3.  Operations performed on this table as seen in `pg_stat_last_operation` catalog table on master.
4.  If possible, the operation that brought the table in this bad state.
5.  Logs containing the most recent operations performed on this table from the troubled segment(s) and master.
6.  Are we able to select from / insert into this table from master?
7.  Was the table rewritten since it was created? This can be determined by comparing `relfilenode` and `OID` of the base table (not auxiliary tables) from `pg_class` on a "good" segment.
8.  Was the system upgraded from 4.2.x to 4.3.x?
    1.  If yes, did the troubled base table exist before upgrade?

9.  Identify the OIDs of the missing auxiliary tables and run the following commands in utility mode on the troubled segment. Make sure you connect to the correct database! Here we assume that `pg_type` contains valid tuples for the auxiliary relations but `pg_class` has them missing.

    ``` theme:
    set gp_select_invisible=true;
    select xmin,xmax,oid,relname,relfilenode,relkind from pg_class where oid in (<auxiliary_oid>, ...);
    select xmin,xmax,oid,typname,typrelid from pg_type where typrelid in (<auxiliary_oid>, ...);
    select * from pg_depend where classid=1259 and objid in (<auxiliary_oid>, ...);
    -- check if it is the index on pg_class that is broken by enforcing sequential scan
    set enable_indexscan=off;
    set enable_seqscan=on;
    select xmin,xmax,oid,relname,relfilenode,relkind from pg_class where oid in (<auxiliary_oid>, ...);
    ```

10. Connect to a good segment in utility mode and run the same commands in previous step. Compare the output.
11. Did  the system or the troubled segment go through a restart (and crash recovery sequence) anytime after the table was created?

 

Document generated by Confluence on May 17, 2016 19:14


