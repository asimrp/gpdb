-- In a multi-slice query execution, readers and writer should use the
-- same in-progress subtransaction information to check visibility of
-- tuples against a snapshot.  The test validates this by executing a
-- multi-slice query and a subtransaction concurrently.

create table sharedsnapshot_t1(a int, b int) distributed by (a);
CREATE
create table sharedsnapshot_t2(a int, b int) distributed by (a);
CREATE

-- Session 1: start a subtransaction and insert a few tuples.  The
-- subtransaction will be included in subxip array of the serializable
-- snapshot taken by session 2.
1: begin;
BEGIN
1: savepoint s1;
SAVEPOINT
1: insert into sharedsnapshot_t1 select 1, i from generate_series(1,5)i;
INSERT 5

-- Advance latestCompletedXid, so that xmax of subsquent snapshots
-- will be newer than session 1's subxid.
insert into sharedsnapshot_t2 select 1, i from generate_series(1,10)i;
INSERT 10

-- Session 2: acquire a serializable snapshot.  Subxip array of this
-- snapshot should include session 1's subtransaction.
2: begin isolation level serializable;
BEGIN
2: select * from gp_dist_random('gp_id');
gpname   |numsegments|dbid|content
---------+-----------+----+-------
Greenplum|-1         |-1  |-1     
Greenplum|-1         |-1  |-1     
Greenplum|-1         |-1  |-1     
(3 rows)

-- Session 3: cursor is a special reader gang.
3: begin isolation level serializable;
BEGIN
3: declare cursor_t1t2 cursor for select * from sharedsnapshot_t1 t1, sharedsnapshot_t2 t2 where t1.a = t2.b;
DECLARE

-- Commit subtransaction and its top transaction.
1: release s1;
RELEASE
1: commit;
COMMIT

-- Run a multi-slice query involving a reader gang.  Readers should
-- consider tuples inserted by session 1's subtransaction as invisible
-- because their xmin should be in-progress according to writer's
-- subxip array.  Note that distributed snapshot is ignored for
-- subtransaction IDs because local to distributed XID mapping is
-- maintained only for top transaction ID.
2: select * from sharedsnapshot_t1 t1, sharedsnapshot_t2 t2 where t1.a = t2.b;
a|b|a|b
-+-+-+-
(0 rows)
2: end;
END

3: fetch all from cursor_t1t2;
a|b|a|b
-+-+-+-
(0 rows)
3: end;
END

-- Obtain a new snapshot so that session0U's xmin's are visible.
2: select * from sharedsnapshot_t1 t1, sharedsnapshot_t2 t2 where t1.a = t2.b;
a|b|a|b
-+-+-+-
1|5|1|1
1|4|1|1
1|3|1|1
1|2|1|1
1|1|1|1
(5 rows)
